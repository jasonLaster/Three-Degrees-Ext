<!DOCTYPE html>
<!--
 * Copyright (c) 2010 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
-->
<html>
  <head>
  </head>
  <body>
    
    
    <script>
    
      // WEB WORKER INTERFACE
      window.cbk = [];
      var worker = new Worker("worker.js");

      worker.onmessage = function (evt) {

      	var action = evt.data.action;
      	var data = evt.data.data;
      	
        if (action == "processFbIds") {
          var ids = data;
          var cbk = window.cbk.pop();
          cbk(ids);
        }
      };

      worker.onerror = function (evt) {
      	console.log('error', evt, evt.data);
      };
      
    
      // SPECIFIC FUNCTIONS
      function pingNinja(callback) {
        
         var xhr = new XMLHttpRequest();
         xhr.onreadystatechange = function(data) {
           if (xhr.readyState == 4) {
             if (xhr.status == 200) {
               var data = xhr.responseText;
               callback(data);
             } else {
               callback(null);
             }
           }
         }

         chrome.tabs.getSelected(null,function(tab) {
           var url = 'http://ec2-50-18-37-176.us-west-1.compute.amazonaws.com/?url=' + tab.url;
           xhr.open('GET', url, true);
           xhr.send();
        });
      };

      function pingFbSearch(url, callback, name) {
         var xhr = new XMLHttpRequest();
         xhr.onreadystatechange = function(data) {
           if (xhr.readyState == 4) {
             if (xhr.status == 200) {
               var data = xhr.responseText;
               callback({'data' : data, 'name' : name});
             } else {
               callback(null);
             }
           }
         }

         xhr.open('GET', url, true);
         xhr.send();
      };

      function getTemplate(callback) {
        var template = $('#popupTemplate').tmpl();
        console.log("TEMPLATE", template);
        callback(template);
      }
      
      // REQUEST HANDLER
      function onRequest(request, sender, callback) {
        console.log(request.action)
        
        if (request.action == 'fetchNames') {
          pingNinja(callback);
        }
        else if (request.action == "fbSearch"){
          var name = request.name;
          var url = 'https://www.facebook.com/search.php?q='+ name + '&type=users&init=srp'
          pingFbSearch(url, callback, name);
        }
        else if (request.action == "getTemplate"){
          getTemplate(callback)
        }
        else if (request.action == "parseFbIds"){
          window.cbk.push(callback);
          worker.postMessage({'action': 'parseFbIds', 'data': request.data})
        }
      };

      // Wire up the listener.
      chrome.extension.onRequest.addListener(onRequest);
      
    </script>
    
    <script id="popupTemplate" type="text/x-jquery-tmpl">

      <div class="ThreeDegrees popup shadow">
        <div class="wrapper">
          <div class="profile">
            <div class="picture-frame">
              <img src="https://graph.facebook.com/jason.laster/picture"></img>
            </div>
          </div>
          <div class="bottom-actions">
          </div>
        </div>
      </div>
  	
    </script>
    
  </body>
</html>